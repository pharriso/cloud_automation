<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>
  <title>Ansible Tower Dynamic Inventories - Manage Enabled Hosts</title>
  <link href="https://cloudautomation2.pharriso.co.uk/css/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="https://cloudautomation2.pharriso.co.uk/css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/styles/default.min.css">
  <style type="text/css">
  
    footer.page-footer{background-image: url(https://cloudautomation2.pharriso.co.uk/images/default.png);}
  
  </style>
</head>
<body>
  <ul id="slide-out" class="side-nav">
    <li><a href="https://cloudautomation2.pharriso.co.uk"><i class="mdi-action-home left"></i>Home<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
    <li><a href="https://cloudautomation2.pharriso.co.uk/categories"><i class="mdi-action-perm-media left"></i>Categories<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
    <li><a href="https://cloudautomation2.pharriso.co.uk/tags"><i class="mdi-action-loyalty left"></i>Tags<i class="mdi-hardware-keyboard-arrow-right right"></i></a></li>
  </ul>
  <div id="index-banner" class="parallax-container">
  <a data-activates="slide-out" class="btn-floating button-collapse" style="top: 5px; left: 5px;"><i class="mdi-navigation-menu"></i></a>
    <div class="section no-pad-bot">
      <div class="container">
        
        <h1 class="header center teal-text text-lighten-2">Cloud and Automation</h1>
        <div class="row center">
          <h5 class="header col s12 light">This blog focuses mainly on Red Hat products in the Cloud and Automation space. I am currently working as a Solution Architect for Red Hat in the UK.</h5>
        </div>
        <div class="row center">
        
        
          <a href="https://github.com/pharriso"><img src="https://cloudautomation2.pharriso.co.uk/images/github2-dreamstale35.png"></a>
        
        
        
          <a href="https://twitter.com/patharrison_esq"><img src="https://cloudautomation2.pharriso.co.uk/images/twitter-dreamstale71.png"></a>
        
        
        
          <a href="https://www.linkedin.com/in/pharriso"><img src="https://cloudautomation2.pharriso.co.uk/images/linkedin-dreamstale45.png"></a>
        
        </div>
      </div>
    </div>
    <div class="parallax">
    
      <img src="https://cloudautomation2.pharriso.co.uk/images/default.png">
    
    </div>
  </div>



<div class="container">
  <div class="section">

    <div class="row">
      <div class="col s12">
        <div class="card-panel">
          <h4>Ansible Tower Dynamic Inventories - Manage Enabled Hosts</h4>
          <p>
           
          </p>
          <p>

<p>If you have used <a href="https://docs.ansible.com/ansible-tower/latest/html/userguide/inventories.html#smart-inventories">dynamic inventories in Ansible Tower</a> before, you may have noticed that it adds some logic to determine whether a host should be enabled for job execution or not. For example, when syncing with our Red Hat Virtualisation environment, it has set some of our hosts to disabled.</p>

<p><img src="/images/tower_inventory_disabled.png" alt="tower_disabled_hosts" /></p>

<p>Why do we get this behaviour? In the case of Red Hat Virtualisation you can probably tell from the screen shot - Tower will disable any VM&rsquo;s which are powered off and we can see the VM&rsquo;s which are disabled show a state of &ldquo;status_down&rdquo;. For VMware, it will disable any VM&rsquo;s where VMware tools isn&rsquo;t reporting a guest state. A lot of the time this is really useful and can reduce job failures - why try to connect to a VM which is powered off? But, there may be times when you want to override this behaviour. For example, you might want to deploy VMware Tools to some guests, but they are being excluded from job execution. Another example we had recently was that we wanted to delete a bunch of VM&rsquo;s in our Red Hat Virtualisation platform which were powered off, but they were being excluded - because they were powered off. Rather than powering on the VM&rsquo;s so that we could delete them, we just amended the behaviour in Tower so that these VM&rsquo;s weren&rsquo;t marked as disabled.</p>

<p>To see how Tower determines if a node is enabled or disabled, you can take a look in <strong>/var/lib/awx/venv/awx/lib/python3.6/site-packages/awx/settings/defaults.py</strong></p>

<p>Looking at RHV (Upstream name is oVirt), we can see:</p>

<pre><code># ---------------------
# ----- oVirt4 -----
# ---------------------
RHV_ENABLED_VAR = 'status'
RHV_ENABLED_VALUE = 'up'
</code></pre>

<p>And for VMware:</p>

<pre><code># Inventory variable name/values for determining whether a host is
# active in vSphere.
VMWARE_ENABLED_VAR = 'guest.gueststate'
VMWARE_ENABLED_VALUE = 'running'
</code></pre>

<h2 id="changing-the-default-behaviour">Changing the default behaviour</h2>

<p>Now that we have seen the default settings and know the variable names, we can override the default behaviour. The easiest way to do this is to create a custom configuration file in /etc/tower/conf.d and override the variable value. For example, to enable all VM&rsquo;s regardless of power status you could create the following file and set the RHV_ENABLED_VALUE to be empty:</p>

<pre><code># cat /etc/tower/conf.d/custom.py 
</code></pre>

<p>RHV_ENABLED_VALUE = &ldquo;</p>

<p>After creating this configuration file, restart the tower services:</p>

<pre><code># ansible-tower-service
</code></pre>

<p>Now when we sync the inventory we can now see that all of the hosts are enabled regardless of power state:</p>

<p><img src="/images/tower_inventory_enabled.png" alt="tower_enabled_hosts" /></p>

<h2 id="summary">Summary</h2>

<p>Ansible Tower tries to be helpful in the way it disables hosts that have been imported from dynamic inventories to try to avoid unnecessary job failures. If you need to configure this behaviour then you can follow the steps outlined above. These steps should not be confused with dynamic inventory filters, which will completely exclude a host from being imported into Ansible Tower.</p>
</p>
          <p>10 Feb 2020
            
              
                <a href="https://cloudautomation2.pharriso.co.uk/tags/ansible/">#ansible</a>
              
                <a href="https://cloudautomation2.pharriso.co.uk/tags/tower/">#tower</a>
              
            
          </p>
          
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s3 m1">
      
        <a class="btn-floating btn-large waves-effect waves-light" href="https://cloudautomation2.pharriso.co.uk/post/ansible-constructed-inventory-plugin/"><i class="mdi-navigation-arrow-back"></i></a>
      
      </div>
      <div class="col s6 m10 center">&nbsp</div>
      <div class="col s3 m1">
      
        <a class="btn-floating btn-large disabled"><i class="mdi-navigation-arrow-forward"></i></a>
      
      </div>
    </div>

  </div>
</div>

  <footer class="page-footer">
    <div class="footer-copyright">
      <div class="container">
      
      <div class="right">Design <a class="grey-text text-lighten-4" href="http://pdevty.github.io/blog/">pdevty</a></div>
      </div>
    </div>
  </footer>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://cloudautomation2.pharriso.co.uk/js/materialize.min.js"></script>
  <script src="https://cloudautomation2.pharriso.co.uk/js/init.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  </body>
</html>

